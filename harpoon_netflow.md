# Using Harpoon to reproduce Netflow traces


## Netflow ##
[**Netflow**](https://en.wikipedia.org/wiki/NetFlow) is a protocol/feature proposed by Cisco to collect statistical information of IP network traffic. With Netflow information network administrator can understand characteristics of network traffic and determine if there is any interesting behavior (e.g., security attacks, congestion, etc).

There are 5 different versions of Netflow: v1, v5 (most popular), v7, v8 and v9. A typical Netflow setup includes three components:
* **Flow exporter**: installed on switches/routers where traffic go through. It extracts and aggregates flow information (TCP and UDP) and sends it to flow collector via UDP packets.
* **Flow collector**: installed on servers to receive flow information from flow exporter and convert it to readable records.
* **Trace analyzor**: can be installed anywhere, but usually work with flow collector and report certain events based on collected flow records.

Most of Netflow implementations are either features come with commerical network devices or licensed softwares. Only a few of them are open source:
* **flow-tools**: flow-tools is a set of programs for processing and managing NetFlow exports from Cisco and Juniper routers. It captures Netflow packets generated by flow exporter programs, extracts flow information and store flow records in its own format (```flow-capture```). It can also be used to generate testing flows, convert format and many other things (```flow-gen, flow-send, flow-expor```, etc.). Harpoon used flow-tools records by default.
* **nfdump**: nfdump is similar to flow-tools. It is a toolset to collect and process netflow data, sent from netflow exporters. It supports netflow v1, v5/v7 v9 and IPFIX. It also contains a collector to collect sflow data (```nfcapd, nfdump, nfprofile```, etc).
* **cflowd**: cannot find too much accurate information about this tool.
* **softflowd**: softflowd is a flow exporter program. It listens promiscuously on a network interface and semi-statefully tracks network flows. These flows can be reported using NetFlow v1, v5, and v9 packets.

### Capturing live traffic
To capture live traffic and generate Netflow information, we can install softflowd ```sudo apt install softflowd``` and run it in the background ```sudo softflowd -n 127.0.0.1:12345 -i em1```. ```-n``` specifies the host and port number where the Netflow packets are sent to and ```-i``` specifies the interface ```softflowd``` monitors.

Then we need to start a flow collector program on the host and port number specified above. Here we use ```flow-tools``` by running ```flow-capture -w . 0/0/12345 -S5```. ```-w```  indicates the directory to store flow records, ```0/0/12345``` is the IP address and port number the program listens to, and ```-S5``` means it report stats message for every 5 minutes.

Finally, we can use ```flow-print``` to examine the flow information collected.
```bash
cao@cap32:~$ flow-print < traces/2017/2017-10/2017-10-23/ft-v05.2017-10-23.203719-0400 | head -10
srcIP            dstIP            prot  srcPort  dstPort  octets      packets
128.10.130.152   128.10.130.205   6     22       52378    35175       578
128.10.130.205   128.10.130.152   6     52378    22       9541275     1583
128.10.2.5       128.10.130.152   17    53       42138    318         1
128.10.130.152   128.10.2.5       17    42138    53       73          1
128.10.2.5       128.10.130.152   17    53       33507    293         1
128.10.130.152   128.10.2.5       17    33507    53       73          1
128.10.2.5       128.10.130.152   17    53       42537    423         2
128.10.130.152   128.10.2.5       17    42537    53       146         2
128.10.2.5       128.10.130.152   17    53       44092    423         2

```

### Exact Netflow from existing traces

## Harpoon ##
[**Harpoon**](http://cs.colgate.edu/~jsommers/harpoon/) is a flow-level traffic generator that mimics flow characteristics extracted from a Netflow trace by transfering files of various sizes over TCP or UDP connections. 
"Harpoon uses a set of distributional parameters that can be automatically extracted from Netflow traces to generate flows that exhibit the same statistical qualities present in measured Internet traces, including temporal and spatial characteristics. Harpoon can be used to generate representative background traffic for application or protocol testing, or for testing network switching hardware."

Harpoon can use ```flow-tools``` format records or raw Netflow format as input. However, the latter is only the UDP payload in binary described in the previous section. Here are the three steps Harpoon takes to generate appropriate configurations from Netflow traces.
1. harpoon_flowproc
2. harpoon_conf.py
3. harpoon_reconf.py


How to remove Ethernet layer from a pcap file?, https://stackoverflow.com/questions/3870482/how-to-remove-ethernet-layer-from-a-pcap-file
exporting payload data in binary file, https://ask.wireshark.org/questions/35353/exporting-payload-data-in-binary-file
Wireshark exporting data, https://www.wireshark.org/docs/wsug_html_chunked/ChIOExportSection.html
Extracting data payload from pcap capture, https://stackoverflow.com/questions/29370186/extracting-data-payload-from-pcap-capture
Dump raw packet 'data' field only?, https://ask.wireshark.org/questions/15374/dump-raw-packet-data-field-only
Is it possible to maintain original Timestamp when using tcpreply?, https://sourceforge.net/p/tcpreplay/mailman/message/34289793/
NetFlow data generation with nfdump and softflowd, http://elf11.github.io/2015/09/10/NetFlows-data-generation.html

pcap-converter, https://github.com/hbhzwj/pcap-converter
flow-tools, https://github.com/adsr/flow-tools, 
Flow-tools Tutorial, https://www.sanog.org/resources/sanog6/gaurab-sanog6-flow-tools.pdf
nfdump, http://nfdump.sourceforge.net/, https://github.com/phaag/nfdump, 
softflowd, https://github.com/davidediger/softflowd
harpoon, http://cs.colgate.edu/~jsommers/harpoon/, https://github.com/jsommers/harpoon


